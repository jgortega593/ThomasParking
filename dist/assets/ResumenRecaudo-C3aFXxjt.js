import{r as t,j as e,E as r,L as z,s as h}from"./index-B8c5qOFd.js";function H({refreshKey:E}){const[q,F]=t.useState([]),[P,b]=t.useState(!0),[v,k]=t.useState(null),[y,_]=t.useState(""),[N,C]=t.useState(!1),[n,D]=t.useState(""),[c,S]=t.useState(""),[j,M]=t.useState(""),[w,f]=t.useState({open:!1,registro:null}),[i,p]=t.useState({}),[$,A]=t.useState([]),[L,U]=t.useState([]);t.useEffect(()=>{(async()=>{const{data:a,error:o}=await h.from("copropietarios").select("propiedad, unidad_asignada");if(!o){const d=[...new Set(a.map(l=>l.propiedad))].sort();A(d),U(a)}})()},[]);const G=n?[...new Set(L.filter(s=>s.propiedad===n).map(s=>s.unidad_asignada))]:[],x=async()=>{b(!0);try{const{data:s,error:a}=await h.from("registros_parqueadero").select(`
          *,
          copropietarios:dependencia_id(nombre, propiedad, unidad_asignada)
        `).order("fecha_hora_ingreso",{ascending:!1});if(a)throw a;F(s)}catch(s){k(s.message)}finally{b(!1)}};t.useEffect(()=>{x()},[E]);const I=async()=>{if(!n||!c){alert("Debe seleccionar propiedad y unidad asignada");return}const s=parseFloat(y);if(isNaN(s)||s<=0){alert("Ingrese un monto válido");return}C(!0);try{const{data:a,error:o}=await h.from("registros_parqueadero").select(`
          *,
          copropietarios:dependencia_id(propiedad, unidad_asignada)
        `).eq("copropietarios.propiedad",n).eq("copropietarios.unidad_asignada",c).eq("recaudado",!1).eq("gratis",!1).order("fecha_hora_ingreso",{ascending:!0});if(o)throw o;if(!(a!=null&&a.length)){alert("No hay registros pendientes para esta propiedad/unidad");return}let d=0;const l=a.filter(u=>d>=s?!1:(d+=Number(u.monto),!0)).map(u=>u.id),{error:m}=await h.from("registros_parqueadero").update({recaudado:!0,fecha_recaudo:new Date().toISOString().slice(0,10)}).in("id",l);if(m)throw m;alert(`Recaudado $${d.toFixed(2)} en ${l.length} registros`),x(),_("")}catch(a){alert("Error: "+a.message)}finally{C(!1)}},R=q.filter(s=>{var l,m,u;const a=!n||(((l=s.copropietarios)==null?void 0:l.propiedad)||"")===n,o=!c||(((m=s.copropietarios)==null?void 0:m.unidad_asignada)||"")===c,d=!j||(((u=s.copropietarios)==null?void 0:u.nombre)||"").toLowerCase().includes(j.toLowerCase());return a&&o&&d}),g=R.reduce((s,a)=>(a.gratis?s.gratis++:a.recaudado?s.recaudado+=Number(a.monto):s.pendiente+=Number(a.monto),s),{recaudado:0,pendiente:0,gratis:0}),O=async()=>{const s=w.registro.id,a=i.gratis?0:i.tipo_vehiculo==="carro"?1:.5;try{const{error:o}=await h.from("registros_parqueadero").update({...i,monto:a}).eq("id",s);if(o)throw o;x(),f({open:!1,registro:null})}catch(o){alert(o.message)}},T=async s=>{if(window.confirm("¿Seguro que desea eliminar este registro?"))try{const{error:a}=await h.from("registros_parqueadero").delete().eq("id",s);if(a)throw a;x()}catch(a){alert(a.message)}};return e.jsxs("div",{className:"resumen-container",children:[e.jsxs("h2",{children:[e.jsx(r,{symbol:"📊",label:"Resumen"})," Resumen de Recaudación"]}),e.jsxs("div",{className:"resumen-visual",children:[e.jsxs("div",{className:"resumen-item recaudado",children:[e.jsx(r,{symbol:"💰"})," $",g.recaudado.toFixed(2),e.jsx("span",{children:"Recaudado"})]}),e.jsxs("div",{className:"resumen-item pendiente",children:[e.jsx(r,{symbol:"⏳"})," $",g.pendiente.toFixed(2),e.jsx("span",{children:"Pendiente"})]}),e.jsxs("div",{className:"resumen-item gratis",children:[e.jsx(r,{symbol:"🆓"})," ",g.gratis,e.jsx("span",{children:"Gratis"})]})]}),e.jsxs("section",{className:"recaudo-automatico",children:[e.jsxs("h3",{children:[e.jsx(r,{symbol:"⚡"})," Recaudo Automático"]}),e.jsxs("div",{className:"filtros-recaudo",children:[e.jsxs("div",{className:"filtro-group",children:[e.jsxs("label",{children:[e.jsx(r,{symbol:"🏠"})," Propiedad:"]}),e.jsxs("select",{value:n,onChange:s=>{D(s.target.value),S("")},children:[e.jsx("option",{value:"",children:"Seleccione propiedad"}),$.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{className:"filtro-group",children:[e.jsxs("label",{children:[e.jsx(r,{symbol:"🔢"})," Unidad:"]}),e.jsxs("select",{value:c,onChange:s=>S(s.target.value),disabled:!n,children:[e.jsx("option",{value:"",children:"Seleccione unidad"}),G.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{className:"filtro-group",children:[e.jsxs("label",{children:[e.jsx(r,{symbol:"💵"})," Monto objetivo:"]}),e.jsx("input",{type:"number",step:"0.01",value:y,onChange:s=>_(s.target.value),placeholder:"Ej: 50.00"})]}),e.jsx("button",{className:"btn-recaudo",onClick:I,disabled:N||!n||!c,children:N?"Procesando...":"Ejecutar Recaudo"})]})]}),e.jsx("div",{className:"filtros-avanzados",children:e.jsxs("div",{className:"filtro-group",children:[e.jsxs("label",{children:[e.jsx(r,{symbol:"👥"})," Copropietario:"]}),e.jsx("input",{type:"text",value:j,onChange:s=>M(s.target.value),placeholder:"Filtrar por nombre"})]})}),e.jsxs("div",{className:"detalle-recaudo",children:[e.jsxs("h3",{children:[e.jsx(r,{symbol:"📋"})," Detalle de Registros"]}),e.jsx("div",{className:"tabla-detalle",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsxs("th",{children:[e.jsx(r,{symbol:"🚗"})," Placa"]}),e.jsxs("th",{children:[e.jsx(r,{symbol:"🛵"})," Tipo"]}),e.jsxs("th",{children:[e.jsx(r,{symbol:"💵"})," Monto"]}),e.jsxs("th",{children:[e.jsx(r,{symbol:"👥"})," Copropietario"]}),e.jsxs("th",{children:[e.jsx(r,{symbol:"📅"})," Fecha Recaudo"]}),e.jsxs("th",{children:[e.jsx(r,{symbol:"⚙️"})," Acciones"]})]})}),e.jsx("tbody",{children:R.map(s=>{var a;return e.jsxs("tr",{className:s.recaudado?"recaudado":"pendiente",children:[e.jsx("td",{children:s.placa_vehiculo}),e.jsx("td",{children:s.tipo_vehiculo}),e.jsxs("td",{children:["$",s.monto.toFixed(2)]}),e.jsx("td",{children:((a=s.copropietarios)==null?void 0:a.nombre)||"-"}),e.jsx("td",{children:s.fecha_recaudo||"-"}),e.jsxs("td",{children:[e.jsx("button",{onClick:()=>{var o;f({open:!0,registro:s}),p({placa_vehiculo:s.placa_vehiculo,tipo_vehiculo:s.tipo_vehiculo,fecha_hora_ingreso:((o=s.fecha_hora_ingreso)==null?void 0:o.slice(0,10))||"",gratis:s.gratis})},children:e.jsx(r,{symbol:"✏️"})}),e.jsx("button",{onClick:()=>T(s.id),children:e.jsx(r,{symbol:"🗑️"})})]})]},s.id)})})]})})]}),w.open&&e.jsxs("div",{className:"modal-edicion",children:[e.jsx("h3",{children:"Editar Registro"}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),O()},children:[e.jsxs("label",{children:["Placa:",e.jsx("input",{value:i.placa_vehiculo,onChange:s=>p({...i,placa_vehiculo:s.target.value}),required:!0})]}),e.jsxs("label",{children:["Tipo:",e.jsxs("select",{value:i.tipo_vehiculo,onChange:s=>p({...i,tipo_vehiculo:s.target.value}),children:[e.jsx("option",{value:"carro",children:"Carro"}),e.jsx("option",{value:"moto",children:"Moto"})]})]}),e.jsxs("label",{children:["Fecha ingreso:",e.jsx("input",{type:"date",value:i.fecha_hora_ingreso,onChange:s=>p({...i,fecha_hora_ingreso:s.target.value})})]}),e.jsxs("label",{className:"checkbox",children:[e.jsx("input",{type:"checkbox",checked:i.gratis,onChange:s=>p({...i,gratis:s.target.checked})}),e.jsx(r,{symbol:"🆓"})," Gratis"]}),e.jsxs("div",{className:"acciones-modal",children:[e.jsx("button",{type:"submit",children:"Guardar"}),e.jsx("button",{type:"button",onClick:()=>f({open:!1,registro:null}),children:"Cancelar"})]})]})]}),P&&e.jsx(z,{text:"Cargando datos..."}),v&&e.jsx("div",{className:"error-message",children:v})]})}export{H as default};
//# sourceMappingURL=ResumenRecaudo-C3aFXxjt.js.map
