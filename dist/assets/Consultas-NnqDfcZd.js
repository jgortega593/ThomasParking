import{j as e,E as l,r,L as V,d as $,s as _}from"./index-B8c5qOFd.js";function z({registros:o=[]}){const c=o.reduce((t,h)=>(h.gratis?t.gratis++:h.recaudado?t.recaudado+=Number(h.monto):t.pendiente+=Number(h.monto),t.total+=Number(h.monto),t.cantidad++,t),{recaudado:0,pendiente:0,gratis:0,total:0,cantidad:0});return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))",gap:"1rem",padding:"1rem",background:"rgba(255, 255, 255, 0.1)",borderRadius:"12px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)"},children:[e.jsxs("div",{style:{textAlign:"center"},children:[e.jsxs("div",{style:{fontSize:"1.5rem"},children:[e.jsx(l,{symbol:"💰"})," $",c.recaudado.toFixed(2)]}),e.jsx("small",{style:{color:"#666"},children:"Recaudado"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsxs("div",{style:{fontSize:"1.5rem"},children:[e.jsx(l,{symbol:"⏳"})," $",c.pendiente.toFixed(2)]}),e.jsx("small",{style:{color:"#666"},children:"Pendiente"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsxs("div",{style:{fontSize:"1.5rem"},children:[e.jsx(l,{symbol:"🆓"})," ",c.gratis]}),e.jsx("small",{style:{color:"#666"},children:"Gratis"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsxs("div",{style:{fontSize:"1.5rem"},children:[e.jsx(l,{symbol:"📋"})," ",c.cantidad]}),e.jsx("small",{style:{color:"#666"},children:"Registros"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsxs("div",{style:{fontSize:"1.5rem"},children:[e.jsx(l,{symbol:"🧾"})," $",c.total.toFixed(2)]}),e.jsx("small",{style:{color:"#666"},children:"Total"})]})]})}function G(){const[o,c]=r.useState(navigator.onLine);return r.useEffect(()=>{const t=()=>c(navigator.onLine);return window.addEventListener("online",t),window.addEventListener("offline",t),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",t)}},[]),o}function Y(){const[o,c]=r.useState({fechaInicio:"",fechaFin:"",placa:"",propiedad:"",unidadAsignada:"",tipoVehiculo:""}),[t,h]=r.useState([]),[f,j]=r.useState([]),[v,N]=r.useState(!0),[w,g]=r.useState(null),[y,A]=r.useState([]),[S,C]=r.useState({open:!1,registro:null}),[d,E]=r.useState({}),u=G();r.useEffect(()=>{(async()=>{const{data:s,error:i}=await _.from("copropietarios").select("id, nombre, propiedad, unidad_asignada");i||A(s)})()},[]),r.useEffect(()=>{(async()=>{N(!0),g(null);try{const{data:s,error:i}=await _.from("registros_parqueadero").select(`
            id,
            placa_vehiculo,
            tipo_vehiculo,
            fecha_hora_ingreso,
            observaciones,
            foto_url,
            gratis,
            monto,
            recaudado,
            fecha_recaudo,
            dependencia_id,
            observacion_audio_url,
            copropietarios:dependencia_id(nombre, propiedad, unidad_asignada),
            usuario:usuario_id!inner(id, nombre)
          `).order("fecha_hora_ingreso",{ascending:!1});if(i)throw i;h(s||[]),j(s||[])}catch(s){g(s.message),h([]),j([])}finally{N(!1)}})()},[]);const L=[...new Set(y.map(a=>a.propiedad))].sort(),T=o.propiedad?[...new Set(y.filter(a=>a.propiedad===o.propiedad).map(a=>a.unidad_asignada))]:[],F=y.find(a=>a.propiedad===o.propiedad&&a.unidad_asignada===o.unidadAsignada),q=a=>{a.preventDefault();let s=[...t];o.fechaInicio&&(s=s.filter(i=>i.fecha_hora_ingreso>=`${o.fechaInicio}T00:00:00`)),o.fechaFin&&(s=s.filter(i=>i.fecha_hora_ingreso<=`${o.fechaFin}T23:59:59`)),o.placa&&(s=s.filter(i=>{var n;return(n=i.placa_vehiculo)==null?void 0:n.toLowerCase().includes(o.placa.toLowerCase())})),o.tipoVehiculo&&(s=s.filter(i=>i.tipo_vehiculo===o.tipoVehiculo)),o.propiedad&&!o.unidadAsignada&&(s=s.filter(i=>{var n;return((n=i.copropietarios)==null?void 0:n.propiedad)===o.propiedad})),o.propiedad&&o.unidadAsignada&&F&&(s=s.filter(i=>i.dependencia_id===F.id)),j(s)},b=a=>{const{name:s,value:i}=a.target;c(n=>({...n,[s]:i,...s==="propiedad"&&{unidadAsignada:""}}))},M=()=>{c({fechaInicio:"",fechaFin:"",placa:"",propiedad:"",unidadAsignada:"",tipoVehiculo:""}),j(t)},D=a=>{var s;C({open:!0,registro:a}),E({placa_vehiculo:a.placa_vehiculo,tipo_vehiculo:a.tipo_vehiculo,fecha_hora_ingreso:((s=a.fecha_hora_ingreso)==null?void 0:s.slice(0,10))||"",gratis:!!a.gratis,observaciones:a.observaciones||"",dependencia_id:a.dependencia_id,recaudado:!!a.recaudado,fecha_recaudo:a.fecha_recaudo||""})},p=a=>{const{name:s,value:i,type:n,checked:x}=a.target;E(m=>({...m,[s]:n==="checkbox"?x:i,...s==="recaudado"&&!x?{fecha_recaudo:""}:{}}))},I=async a=>{a.preventDefault();const s=S.registro.id,i=d.gratis?0:d.tipo_vehiculo==="carro"?1:.5;try{const{error:n}=await _.from("registros_parqueadero").update({...d,monto:i}).eq("id",s);if(n)throw n;const x=t.map(m=>m.id===s?{...m,...d,monto:i}:m);h(x),j(x),C({open:!1,registro:null})}catch(n){g(n.message)}},P=async a=>{if(window.confirm("¿Seguro que deseas eliminar este registro?"))try{const{error:s}=await _.from("registros_parqueadero").delete().eq("id",a.id);if(s)throw s;const i=t.filter(n=>n.id!==a.id);h(i),j(i)}catch(s){g(s.message)}};return e.jsxs("div",{className:"consultas-container",children:[e.jsxs("h2",{children:[e.jsx(l,{symbol:"🔎",label:"Consultas"})," Consultas y Reportes"]}),e.jsxs("form",{onSubmit:q,className:"filtros-form",children:[e.jsxs("div",{className:"filtros-grid",children:[e.jsxs("div",{className:"filtro-item",children:[e.jsx("label",{children:"Fecha inicio:"}),e.jsx("input",{type:"date",name:"fechaInicio",value:o.fechaInicio,onChange:b})]}),e.jsxs("div",{className:"filtro-item",children:[e.jsx("label",{children:"Fecha fin:"}),e.jsx("input",{type:"date",name:"fechaFin",value:o.fechaFin,onChange:b})]}),e.jsxs("div",{className:"filtro-item",children:[e.jsx("label",{children:"Placa:"}),e.jsx("input",{type:"text",name:"placa",placeholder:"Buscar por placa",value:o.placa,onChange:b})]}),e.jsxs("div",{className:"filtro-item",children:[e.jsx("label",{children:"Propiedad:"}),e.jsxs("select",{name:"propiedad",value:o.propiedad,onChange:b,children:[e.jsx("option",{value:"",children:"Todas"}),L.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{className:"filtro-item",children:[e.jsx("label",{children:"Unidad asignada:"}),e.jsxs("select",{name:"unidadAsignada",value:o.unidadAsignada,onChange:b,disabled:!o.propiedad,children:[e.jsx("option",{value:"",children:"Todas"}),T.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{className:"filtro-item",children:[e.jsx("label",{children:"Tipo vehículo:"}),e.jsxs("select",{name:"tipoVehiculo",value:o.tipoVehiculo,onChange:b,children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"carro",children:"Carro 🚗"}),e.jsx("option",{value:"moto",children:"Moto 🏍️"})]})]})]}),e.jsxs("div",{className:"acciones-filtros",children:[e.jsx("button",{type:"submit",disabled:v,className:"btn-buscar",children:v?"Buscando...":"Buscar"}),e.jsx("button",{type:"button",onClick:M,className:"btn-limpiar",children:"Limpiar"})]})]}),w&&e.jsx("div",{className:"error-message",children:w}),v&&e.jsx(V,{text:"Buscando registros..."}),f.length>0&&e.jsx(z,{registros:f,titulo:"Resumen de Consultas"}),f.length>0?e.jsx("div",{className:"resultados-table-container",style:{maxHeight:"500px",overflowY:"auto",overflowX:"auto",border:"1px solid #ccc",borderRadius:8},children:e.jsxs("table",{className:"resultados-table",style:{width:"max-content",minWidth:"100%"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsxs("th",{children:[e.jsx(l,{symbol:"📅",label:"Fecha"})," Fecha"]}),e.jsxs("th",{children:[e.jsx(l,{symbol:"🚗",label:"Placa"})," Placa"]}),e.jsxs("th",{children:[e.jsx(l,{symbol:"🏍️",label:"Tipo"})," Tipo"]}),e.jsxs("th",{children:[e.jsx(l,{symbol:"👥",label:"Copropietario"})," Copropietario"]}),e.jsxs("th",{children:[e.jsx(l,{symbol:"💵",label:"Monto"})," Monto"]}),e.jsxs("th",{children:[e.jsx(l,{symbol:"🟢",label:"Estado"})," Estado"]}),e.jsxs("th",{children:[e.jsx(l,{symbol:"📷",label:"Foto"})," Foto"]}),e.jsxs("th",{children:[e.jsx(l,{symbol:"👤",label:"Registrado por"})," Registrado por"]}),e.jsxs("th",{children:[e.jsx(l,{symbol:"⚙️",label:"Acciones"})," Acciones"]})]})}),e.jsx("tbody",{children:f.map(a=>{var s,i,n,x,m,R,k;return e.jsxs("tr",{className:a.gratis?"registro-gratis":"",children:[e.jsx("td",{children:a.fecha_hora_ingreso?$(a.fecha_hora_ingreso).format("DD/MM/YYYY"):""}),e.jsx("td",{children:a.placa_vehiculo}),e.jsxs("td",{children:[((s=a.tipo_vehiculo)==null?void 0:s.toLowerCase())==="carro"&&e.jsx(l,{symbol:"🚗"}),((i=a.tipo_vehiculo)==null?void 0:i.toLowerCase())==="moto"&&e.jsx(l,{symbol:"🏍️"}),e.jsx("span",{style:{marginLeft:6},children:(n=a.tipo_vehiculo)==null?void 0:n.toUpperCase()})]}),e.jsxs("td",{children:[((x=a.copropietarios)==null?void 0:x.nombre)||"-",e.jsx("br",{}),e.jsxs("small",{children:[((m=a.copropietarios)==null?void 0:m.propiedad)||"Sin propiedad"," - ",((R=a.copropietarios)==null?void 0:R.unidad_asignada)||"Sin unidad"]})]}),e.jsxs("td",{children:["$",Number(a.monto).toFixed(2)]}),e.jsx("td",{children:a.gratis?e.jsx(l,{symbol:"🆓",label:"Gratis"}):a.recaudado?e.jsx(l,{symbol:"🔗",label:"Recaudado"}):e.jsx(l,{symbol:"⏳",label:"Pendiente"})}),e.jsx("td",{children:a.foto_url&&e.jsx("a",{href:a.foto_url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:a.foto_url,alt:"Evidencia",className:"thumbnail"})})}),e.jsx("td",{children:((k=a.usuario)==null?void 0:k.nombre)||"-"}),e.jsxs("td",{children:[e.jsx("button",{className:"edit-btn",onClick:()=>D(a),title:"Editar",disabled:!u,children:e.jsx(l,{symbol:"✏️",label:"Editar"})}),e.jsx("button",{className:"delete-btn",onClick:()=>P(a),title:"Eliminar",children:e.jsx(l,{symbol:"🗑️",label:"Eliminar"})})]})]},a.id)})})]})}):!v&&e.jsx("div",{className:"sin-resultados",children:"No se encontraron resultados"}),S.open&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("h3",{children:[e.jsx(l,{symbol:"✏️"})," Editar Registro"]}),e.jsxs("form",{onSubmit:I,children:[e.jsxs("label",{children:["Placa:",e.jsx("input",{name:"placa_vehiculo",value:d.placa_vehiculo,onChange:p,required:!0,disabled:!u})]}),e.jsxs("label",{children:["Tipo:",e.jsxs("select",{name:"tipo_vehiculo",value:d.tipo_vehiculo,onChange:p,required:!0,disabled:!u,children:[e.jsx("option",{value:"carro",children:"Carro 🚗"}),e.jsx("option",{value:"moto",children:"Moto 🏍️"})]})]}),e.jsxs("label",{children:["Fecha ingreso:",e.jsx("input",{type:"date",name:"fecha_hora_ingreso",value:d.fecha_hora_ingreso,onChange:p,required:!0,disabled:!u})]}),e.jsxs("label",{children:["Observaciones:",e.jsx("input",{name:"observaciones",value:d.observaciones,onChange:p,disabled:!u})]}),e.jsxs("label",{children:["Copropietario:",e.jsxs("select",{name:"dependencia_id",value:d.dependencia_id||"",onChange:p,required:!0,disabled:!u,children:[e.jsx("option",{value:"",children:"Seleccione..."}),y.map(a=>e.jsxs("option",{value:a.id,children:[a.nombre," (",a.propiedad," - ",a.unidad_asignada,")"]},a.id))]})]}),e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",name:"gratis",checked:!!d.gratis,onChange:p,disabled:!u}),e.jsx(l,{symbol:"🆓",label:"Gratis"})," Gratis"]}),e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",name:"recaudado",checked:!!d.recaudado,onChange:p,disabled:!u}),e.jsx(l,{symbol:"🔗",label:"Recaudado"})," Recaudado"]}),d.recaudado&&e.jsxs("label",{children:["Fecha Recaudo:",e.jsx("input",{type:"date",name:"fecha_recaudo",value:d.fecha_recaudo||"",onChange:p,required:!!d.recaudado,disabled:!u||!d.recaudado})]}),e.jsxs("div",{className:"acciones-modal",children:[e.jsx("button",{type:"submit",className:"save-btn",disabled:!u,children:"Guardar"}),e.jsx("button",{type:"button",className:"cancel-btn",onClick:()=>C({open:!1,registro:null}),children:"Cancelar"})]})]})]})})]})}export{Y as default};
//# sourceMappingURL=Consultas-NnqDfcZd.js.map
